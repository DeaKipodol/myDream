# 추가 요구사항 보고서

**프로젝트**: 대화 트리 관리 CLI (Phase CLI-1)
**작성일**: 2025-11-30
**상태**: PM 검토 필요

---

## 📋 요약

Phase CLI-1 개발 중 원래 계획에 없던 추가 요구사항이 발견되어 구현되었습니다. 모든 추가 기능은 사용자 테스트 과정에서 발견된 UX 문제점을 해결하고, 실제 사용성을 크게 개선하기 위한 것입니다.

---

## 🆕 추가 요구사항 목록

### 1. OpenAI API 통합

**분류**: 핵심 기능 추가
**우선순위**: 높음
**구현 상태**: ✅ 완료

#### 배경 및 이유
- 원래 계획에는 AI 통합이 포함되지 않았음
- 사용자가 실제 LLM API 키를 보유하고 있어, 하드코딩된 응답 대신 실제 AI 응답을 원함
- 실제 사용 시나리오에서 필수적인 기능으로 판단

#### 구현 내용
- `core/ai_client.py` 모듈 신규 생성
- OpenAI GPT 모델 통합 (gpt-4o-mini 기본)
- 대화 컨텍스트 관리 기능
- `/ask` 명령어로 실시간 AI 질문/응답 가능
- API 키 없이도 CLI 동작 가능 (선택적 기능)

#### 영향 범위
- **추가 파일**: `core/ai_client.py`, `.env.example`
- **수정 파일**: `cli/cli.py`, `requirements.txt`
- **의존성 추가**: `openai>=1.0.0`, `python-dotenv>=1.0.0`

#### 테스트 필요 여부
- ✅ 단위 테스트 필요: `tests/test_ai_client.py` (미작성)
- ✅ 통합 테스트 필요: 실제 API 키로 동작 확인
- ⚠️ 비용 발생 가능: OpenAI API 사용량에 따라 과금

---

### 2. 노드 번호 시스템 (n1, n2, ...)

**분류**: UX 개선
**우선순위**: 중간
**구현 상태**: ✅ 완료

#### 배경 및 이유
- 사용자가 UUID 전체 또는 부분을 타이핑하는 것이 너무 번거로움
- CLI 환경에서 빠른 작업 흐름을 위해 간단한 참조 방식 필요
- "CLI에서만 ID 입력하는게 번거로우니, 노드를 숫자와 대응시켜서 n1, n2 이런식으로" (사용자 직접 요청)

#### 구현 내용
- 모든 노드에 자동 번호 부여 (n1, n2, n3, ...)
- 노드 추가/삭제 시 동적 인덱스 갱신
- 새로운 명령어: `nodes`, `list` - 번호와 함께 전체 노드 목록 표시
- 기존 명령어 개선: `switch`, `node`, `siblings` 모두 n1, n2 형식 지원
- UUID 부분 매칭 기능 유지 (하위 호환성)

#### 영향 범위
- **수정 파일**: `cli/cli.py`
- **새 메서드**: `_build_node_index()`, `_resolve_node_reference()`, `cmd_nodes()`
- **UI 변경**: 환영 메시지, 도움말, 현재 위치 표시 등

#### 테스트 필요 여부
- ⚠️ 단위 테스트 필요: 인덱스 생성/갱신 로직
- ⚠️ 엣지 케이스: 노드 삭제 시 번호 재할당 동작 확인

---

### 3. CLI 명령어 UX 개선

**분류**: UX 개선
**우선순위**: 중간
**구현 상태**: ✅ 완료

#### 3.1 슬래시(/) 접두사 선택적 사용

**배경**: 매번 `/`를 입력하는 것이 번거로움
**구현**: 모든 명령어를 `/` 없이도 사용 가능
**예시**: `help`, `ask 질문`, `switch n1` 모두 작동

#### 3.2 부분 노드 ID 매칭

**배경**: 전체 UUID를 입력하기 어려움
**구현**:
- UUID 앞 8자만 입력해도 노드 전환 가능
- 여러 매칭 발생 시 선택지 제공
- 단일 매칭 시 자동 전환

**예시**: `switch cb5975d0` 작동 (전체 UUID 불필요)

#### 3.3 버그 수정

**Issue**: `/history` 명령어 실행 시 즉시 크래시
**원인**: `get_conversation_history()` 반환값 타입 오해
**수정**: 튜플 언패킹 방식 수정

---

### 4. 분기 자동 체크포인트 & Navigation History

**분류**: 핵심 기능 추가
**우선순위**: 높음
**구현 상태**: ✅ 완료

#### 배경 및 이유
- 노드가 실제 분기점이 되는 순간을 자동으로 감지하고 체크포인트로 저장 필요
- 사용자가 switch로 이동한 경로를 추적하여 쉽게 되돌아갈 수 있는 기능 필요
- "노드는 대화의 한 시점이 될 수 있고, 사용자가 새 질문을 입력하는 의사가 있어야 분기점으로 활성화됩니다" (사용자 요구)

#### 구현 내용

**4.1 분기 자동 체크포인트**
- `_auto_checkpoint_on_branch()` 헬퍼 메서드 구현
- `cmd_ask()` 및 `cmd_turn()` 실행 시 분기 감지
- 현재 노드에 자식이 1개 이상일 때 새 노드 추가 시 자동 체크포인트 생성
- 명명 규칙: `@branch_<node_id>` (예: `@branch_cb5975d0`)
- 중복 방지: 이미 생성된 체크포인트는 재생성하지 않음

**4.2 Navigation History**
- `self.navigation_history` 리스트로 이동 이력 추적
- `cmd_switch()` 실행 시 현재 위치를 이력에 자동 저장
- `back` 명령어: 이전 위치로 빠르게 복귀
- `visits` 명령어: 최근 방문 이력 보기 (최근 10개)
- 시간 포맷팅: "방금 전", "5분 전", "2시간 전" 등 한국어 표시
- 최근 20개 이력만 유지 (메모리 절약)

**4.3 UI 개선**
- `checkpoint list` 명령어 출력을 3섹션으로 개선:
  1. 명시적 체크포인트 (사용자가 직접 생성)
  2. 분기 노드 (@branch_* 접두사)
  3. 최근 방문 이력
- help 명령어에 새 기능 설명 추가

#### 영향 범위
- **수정 파일**: `cli/cli.py`
- **추가 메서드**:
  - `_auto_checkpoint_on_branch()`
  - `_format_elapsed_time()`
  - `cmd_back()`
  - `cmd_visits()`
- **수정 메서드**:
  - `__init__()`: navigation_history 초기화
  - `cmd_ask()`: 분기 감지 추가
  - `cmd_turn()`: 분기 감지 추가
  - `cmd_switch()`: 이력 저장 추가
  - `_checkpoint_list()`: 3섹션 출력
  - `cmd_help()`: 새 명령어 설명
- **새 명령어**: `back`, `visits`

#### 테스트 결과
- ✅ 분기 자동 체크포인트 생성 테스트 통과
- ✅ Navigation history 추적 테스트 통과
- ✅ 시간 포맷팅 테스트 통과
- ✅ 기존 109개 단위 테스트 모두 통과 (회귀 없음)

#### 사용 예시

```bash
> ask "Python이란?"
✅ 노드 생성됨: n1

> ask "장점은?"
✅ 노드 생성됨: n2

> switch n1
✅ 노드 n1로 전환

> ask "단점은?"
🔀 분기 발생: 자동 체크포인트 '@branch_cb5975d0' 생성됨
✅ 노드 생성됨: n3

> checkpoint list
[분기 노드] (1개) 🔀
  • @branch_cb5975d0 → n1
    질문: Python이란?
    자식: 2개 (분기점)

[최근 방문] (1개) 📜
  • n1 - Python이란? (방금 전)

> back
✅ 이전 위치로 돌아갔습니다.
   질문: Python이란?
```

---

## 📊 전체 영향 분석

### 추가된 파일
```
core/ai_client.py           # OpenAI API 클라이언트
.env.example                # 환경 변수 템플릿
docs/ADDITIONAL_REQUIREMENTS.md  # 본 문서
test_new_features.py        # 신규 기능 수동 테스트 스크립트
```

### 수정된 파일
```
cli/cli.py                  # 대부분의 UX 개선 포함
                            # - 분기 자동 체크포인트
                            # - Navigation history
                            # - 노드 번호 시스템
requirements.txt            # 의존성 추가
```

### 의존성 변경
```diff
+ openai>=1.0.0
+ python-dotenv>=1.0.0
```

### 코드 변경량 (실제)
- **추가**: ~400 라인
  - ai_client.py: ~100 라인
  - 노드 번호 시스템: ~100 라인
  - 분기 자동 체크포인트: ~100 라인
  - Navigation history: ~100 라인
- **수정**: ~200 라인 (기존 CLI 명령어 개선)
- **테스트**: test_new_features.py ~100 라인

---

## ⚠️ 리스크 및 우려사항

### 1. 테스트 커버리지 감소
- AI 클라이언트에 대한 단위 테스트 없음
- 노드 번호 시스템에 대한 테스트 없음
- **권장 조치**: Day 5.1에서 테스트 작성 필수

### 2. OpenAI API 비용
- 실제 사용 시 API 호출 비용 발생
- 사용량 제한 없음 (무제한 호출 가능)
- **권장 조치**:
  - 최대 토큰 수 제한 (현재 1024로 설정됨)
  - 사용량 모니터링 기능 추가 검토

### 3. 노드 번호 재할당 문제
- 노드 삭제 시 번호가 변경될 수 있음
- 사용자가 이전에 기억한 번호가 무효화될 수 있음
- **현재 동작**: ID 기준 정렬로 일관성 유지
- **향후 개선**: 번호 고정 옵션 검토 가능

### 4. 성능 고려사항
- 매 명령어마다 `_build_node_index()` 호출
- 노드가 많아질 경우 성능 저하 가능성
- **현재 상태**: 소규모 트리에서는 문제없음
- **향후 개선**: 인덱스 캐싱 및 증분 업데이트 검토

---

## 📝 권장 사항

### 즉시 조치 필요
1. ✅ **PM 승인 필요**: 추가 요구사항 전체에 대한 공식 승인
2. ⚠️ **테스트 작성**: Day 5.1에 AI 클라이언트 및 노드 번호 시스템 테스트 추가
3. ⚠️ **문서화**: README_CLI.md에 새로운 기능 반영 필수

### 향후 검토 필요
1. OpenAI API 사용량 모니터링 및 제한 기능
2. 노드 번호 고정 옵션
3. 대규모 트리에서의 성능 최적화
4. 다른 LLM 제공자 지원 (Anthropic, Cohere 등)

---

## 🎯 다음 단계

### Day 5 작업 계획 수정 제안

**원래 계획**:
- Day 5.1: 시나리오 4-5 테스트 및 버그 수정
- Day 5.2: README_CLI.md 작성
- Day 5.3: 코드 정리

**수정 제안**:
- Day 5.1:
  - ✅ 추가 기능 테스트 작성 (ai_client, node indexing)
  - ✅ 시나리오 4-5 통합 테스트
  - ✅ 버그 수정
- Day 5.2: README_CLI.md 작성 (새 기능 포함)
- Day 5.3: 코드 정리 및 최종 검증

---

## 📎 참고 자료

### 관련 파일
- `core/ai_client.py` - OpenAI 통합
- `cli/cli.py:143-203` - 노드 인덱싱 로직
- `cli/cli.py:500-538` - nodes 명령어
- `.env.example` - 환경 변수 설정 예시

### 사용자 피드백 (원문)
1. "지금 llm 환경키도 넣을라니까 혹시 실제 ai 응답이 담기게 할수있어?"
2. "명령어 다치는게 너무 힘들고"
3. "CLI에서만 아이디를 입력하는게 번거로우니, 노드를 숫자와 대응 시켜서 n1,n2 이런식으로"

---

## ✅ 승인 요청

**요청 사항**:
- [x] 추가 요구사항 전체 승인
- [x] OpenAI API 비용 발생 승인
- [x] Day 5 일정 조정 승인
- [x] 추가 테스트 작성 승인

**검토자**: PM
**검토 완료일**: 2025-11-30
**결과**: ✅ **전체 승인**

---

## 📝 PM 검토 의견

### 승인 사유

1. **OpenAI API 통합**:
   - 원래 CLI-2 범위였으나, 사용자 요청으로 조기 구현은 합리적
   - API 키 없이도 CLI 동작 가능 (선택적 기능)
   - 비용 위험은 max_tokens=1024로 어느 정도 제한됨

2. **노드 번호 시스템 (n1, n2...)**:
   - CLI UX 개선에 필수적인 기능
   - 사용자가 직접 요청한 기능
   - UUID 입력의 번거로움 해결

3. **CLI UX 개선**:
   - 슬래시 접두사 선택적: 사용성 크게 향상
   - 부분 ID 매칭: 실용적 기능
   - 버그 수정: 필수 작업

### 조건 및 권고사항

1. **Day 5 필수 작업**:
   - [ ] `tests/test_ai_client.py` 작성 필수
   - [ ] 노드 인덱싱 테스트 작성 권장
   - [ ] README_CLI.md에 새 기능 문서화 필수

2. **API 비용 관리**:
   - 현재 max_tokens=1024는 적절함
   - 향후 사용량 모니터링 기능 검토 권장

3. **향후 개선 사항** (Phase CLI-2/3에서 검토):
   - 다른 LLM 제공자 지원 (Anthropic 등)
   - 노드 번호 고정 옵션
   - 대규모 트리 성능 최적화

### 영향 분석

| 항목 | 영향 |
|------|------|
| 일정 | Day 5 테스트 작성 추가 (일정 내 소화 가능) |
| 범위 | CLI-1 범위 확장 (LLM 통합은 원래 CLI-2) |
| 품질 | 테스트 커버리지 일시적 감소 → Day 5에서 보완 |
| 비용 | OpenAI API 비용 발생 (사용자 동의 전제) |

---

**최종 결정**: ✅ **승인** - Day 5 작업 진행 가능

---

**문서 버전**: 1.1
**최종 수정**: 2025-11-30 (PM 검토 완료)
