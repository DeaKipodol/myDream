# ë…¸ë“œ ë¶„í•  ìë£Œêµ¬ì¡° ë¶„ì„

## ì§ˆë¬¸

> "í•˜ë‚˜ì˜ ë…¸ë“œ [{Q1,A1}, {Q2,A2}, {Q3,A3}, {Q4,A4}]ë¥¼ ì¤‘ê°„ì—ì„œ ë¬¼ë¦¬ì ìœ¼ë¡œ ìª¼ê°¤ ìˆ˜ ìˆëŠëƒ?"

**ë‹µë³€**: **ê°€ëŠ¥í•©ë‹ˆë‹¤**. ìë£Œêµ¬ì¡°ì ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## ë°©ì‹ Bì˜ ë…¸ë“œ ë¶„í•  ì—°ì‚°

### ìë£Œêµ¬ì¡° ì •ì˜

```python
class Node:
    id: str
    parent_id: str | None
    messages: List[Dict]  # [{role: "user", content: "..."}, ...]
    created_at: timestamp

# ì „ì—­ ìƒíƒœ
all_nodes: Dict[str, Node] = {}
```

### ë¶„í•  ì—°ì‚° (Node Split Operation)

```python
def split_node(
    node_id: str,
    split_index: int
) -> Tuple[str, str]:
    """
    ë…¸ë“œë¥¼ split_index ì§€ì ì—ì„œ ë‘ ê°œë¡œ ë¶„í• 

    Args:
        node_id: ë¶„í• í•  ë…¸ë“œ ID
        split_index: ë¶„í•  ì§€ì  (ë©”ì‹œì§€ ì¸ë±ìŠ¤)

    Returns:
        (ì•ë¶€ë¶„_ë…¸ë“œ_id, ë’·ë¶€ë¶„_ë…¸ë“œ_id)

    Example:
        node_1 = [{Q1,A1}, {Q2,A2}, {Q3,A3}, {Q4,A4}]
        split_node("node_1", 4)  # Q2 ì´í›„ (ì¸ë±ìŠ¤ 4 = A2 ë‹¤ìŒ)

        ê²°ê³¼:
        node_1_front = [{Q1,A1}, {Q2,A2}]
        node_1_back = [{Q3,A3}, {Q4,A4}]
    """

    # 1. ì›ë³¸ ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°
    original = all_nodes[node_id]
    messages = original.messages

    # 2. ë©”ì‹œì§€ ë¶„í• 
    front_messages = messages[:split_index]
    back_messages = messages[split_index:]

    # 3. ì•ë¶€ë¶„ ë…¸ë“œ ìƒì„±
    front_id = generate_uuid()
    front_node = Node(
        id=front_id,
        parent_id=original.parent_id,  # ì›ë³¸ì˜ ë¶€ëª¨ë¥¼ ê·¸ëŒ€ë¡œ
        messages=front_messages,
        created_at=now()
    )

    # 4. ë’·ë¶€ë¶„ ë…¸ë“œ ìƒì„±
    back_id = generate_uuid()
    back_node = Node(
        id=back_id,
        parent_id=front_id,  # ì•ë¶€ë¶„ì„ ë¶€ëª¨ë¡œ
        messages=back_messages,
        created_at=now()
    )

    # 5. ì›ë³¸ì˜ ìì‹ë“¤ì„ ë’·ë¶€ë¶„ìœ¼ë¡œ ì¬ì—°ê²°
    for node in all_nodes.values():
        if node.parent_id == node_id:
            node.parent_id = back_id

    # 6. íŠ¸ë¦¬ì— ì¶”ê°€
    all_nodes[front_id] = front_node
    all_nodes[back_id] = back_node

    # 7. ì›ë³¸ ë…¸ë“œ ì‚­ì œ
    del all_nodes[node_id]

    return (front_id, back_id)
```

---

## ì¤‘ê°„ ì‚½ì… ì „ì²´ íë¦„ (ë°©ì‹ B)

### ì‹œë‚˜ë¦¬ì˜¤
```
ì›ë³¸:
node_1 = [{Q1,A1}, {Q2,A2}, {Q3,A3}, {Q4,A4}]

ëª©í‘œ:
Q2ì™€ Q3 ì‚¬ì´ì— NEW ì‚½ì…
```

### êµ¬í˜„

```python
def insert_between(
    node_id: str,
    split_index: int,
    new_question: str,
    new_answer: str
) -> str:
    """
    ë…¸ë“œ ì¤‘ê°„ì— ìƒˆ ëŒ€í™” ì‚½ì…

    Returns:
        ìƒˆë¡œ ì‚½ì…ëœ ë…¸ë“œ ID
    """

    # 1. ë…¸ë“œ ë¶„í• 
    front_id, back_id = split_node(node_id, split_index)

    # 2. ìƒˆ ë…¸ë“œ ìƒì„±
    new_id = generate_uuid()
    new_node = Node(
        id=new_id,
        parent_id=front_id,  # ì•ë¶€ë¶„ì˜ ìì‹
        messages=[
            {"role": "user", "content": new_question},
            {"role": "assistant", "content": new_answer}
        ],
        created_at=now()
    )

    # 3. ë’·ë¶€ë¶„ì„ ìƒˆ ë…¸ë“œì˜ ìì‹ìœ¼ë¡œ
    all_nodes[back_id].parent_id = new_id

    # 4. íŠ¸ë¦¬ì— ì¶”ê°€
    all_nodes[new_id] = new_node

    return new_id


# ì‚¬ìš© ì˜ˆì‹œ
insert_between(
    node_id="node_1",
    split_index=4,  # Q2 ì´í›„ (A2 ë‹¤ìŒ)
    new_question="ìƒˆ ì§ˆë¬¸",
    new_answer="ìƒˆ ì‘ë‹µ"
)

# ê²°ê³¼ íŠ¸ë¦¬:
# node_1_front [{Q1,A1}, {Q2,A2}]
#      â†“
# node_NEW [{Q_new, A_new}]
#      â†“
# node_1_back [{Q3,A3}, {Q4,A4}]
```

---

## ë°©ì‹ A vs ë°©ì‹ B ë¹„êµ (ì¤‘ê°„ ì‚½ì… ê´€ì )

### ë°©ì‹ A (1í„´ = 1ë…¸ë“œ)

```python
# ì´ˆê¸° ìƒíƒœ (ì´ë¯¸ ìª¼ê°œì ¸ ìˆìŒ)
node_Q1A1
  â†“
node_Q2A2
  â†“
node_Q3A3
  â†“
node_Q4A4

# Q2ì™€ Q3 ì‚¬ì´ ì‚½ì…
def insert_between_A(after_node_id: str, before_node_id: str):
    """
    ë°©ì‹ A: ë‹¨ìˆœíˆ parent_id ì¬í• ë‹¹
    """
    # 1. ìƒˆ ë…¸ë“œ ìƒì„±
    new_node = create_node(
        parent_id=after_node_id,  # Q2 ë…¸ë“œ
        question="ìƒˆ ì§ˆë¬¸",
        answer="ìƒˆ ì‘ë‹µ"
    )

    # 2. Q3 ë…¸ë“œì˜ ë¶€ëª¨ë¥¼ NEWë¡œ ë³€ê²½
    all_nodes[before_node_id].parent_id = new_node.id

    # ì™„ë£Œ!

# í˜¸ì¶œ
insert_between_A("node_Q2A2", "node_Q3A3")

# ê²°ê³¼:
# node_Q1A1 â†’ node_Q2A2 â†’ node_NEW â†’ node_Q3A3 â†’ node_Q4A4
```

**ì½”ë“œ ë³µì¡ë„**: â­â­ (ë§¤ìš° ê°„ë‹¨)

---

### ë°©ì‹ B (ë²„í¼ ê¸°ë°˜)

```python
# ì´ˆê¸° ìƒíƒœ
node_1 = [{Q1,A1}, {Q2,A2}, {Q3,A3}, {Q4,A4}]

# Q2ì™€ Q3 ì‚¬ì´ ì‚½ì…
def insert_between_B(node_id: str, split_index: int):
    """
    ë°©ì‹ B: ë…¸ë“œ ë¶„í•  â†’ ì‚½ì… â†’ ì¬ì—°ê²°
    """
    # 1. ë…¸ë“œ ë¶„í•  (ë³µì¡í•œ ì—°ì‚°)
    front_id, back_id = split_node(node_id, split_index)

    # 2. ìƒˆ ë…¸ë“œ ìƒì„±
    new_id = create_node(...)

    # 3. ì¬ì—°ê²°
    all_nodes[back_id].parent_id = new_id

    # ì™„ë£Œ

# í˜¸ì¶œ
insert_between_B("node_1", 4)  # ì¸ë±ìŠ¤ ê³„ì‚° í•„ìš”!

# ê²°ê³¼:
# node_front â†’ node_NEW â†’ node_back
```

**ì½”ë“œ ë³µì¡ë„**: â­â­â­â­â­ (ë³µì¡)

---

## ìë£Œêµ¬ì¡°ì  ê°€ëŠ¥ì„± vs ì‹¤ìš©ì„±

### ê°€ëŠ¥ì„±: âœ… ê°€ëŠ¥í•¨

**ë°©ì‹ Bì—ì„œ ë…¸ë“œ ë¶„í• ì€ ìë£Œêµ¬ì¡°ì ìœ¼ë¡œ ì™„ì „íˆ êµ¬í˜„ ê°€ëŠ¥**
- List slicing: `messages[:4]`, `messages[4:]`
- ìƒˆ ë…¸ë“œ ìƒì„±
- parent_id ì¬í• ë‹¹
- ì›ë³¸ ì‚­ì œ

```python
# ìë£Œêµ¬ì¡°ì  êµ¬í˜„
front = messages[:split_index]  # O(k) where k = front length
back = messages[split_index:]   # O(n-k) where n = total length

# ë©”ëª¨ë¦¬: ì›ë³¸ ë³µì‚¬ í•„ìš”
# ì‹œê°„: O(n)
```

### ì‹¤ìš©ì„±: âŒ ë¬¸ì œ ë§ìŒ

#### ë¬¸ì œ 1: ì¸ë±ìŠ¤ ê³„ì‚°ì˜ ì–´ë ¤ì›€

```python
# ì‚¬ìš©ì: "Q2ì™€ Q3 ì‚¬ì´ì— ì‚½ì…í•˜ê³  ì‹¶ì–´"

# ë°©ì‹ A (ëª…í™•í•¨)
/insert_after node_Q2A2
# ë˜ëŠ”
/reparent node_Q3A3 node_NEW

# ë°©ì‹ B (ì• ë§¤í•¨)
node_1.messages = [
    {role: "user", content: "Q1"},      # ì¸ë±ìŠ¤ 0
    {role: "assistant", content: "A1"}, # ì¸ë±ìŠ¤ 1
    {role: "user", content: "Q2"},      # ì¸ë±ìŠ¤ 2
    {role: "assistant", content: "A2"}, # ì¸ë±ìŠ¤ 3  â† A2 ì´í›„
    {role: "user", content: "Q3"},      # ì¸ë±ìŠ¤ 4
    {role: "assistant", content: "A3"}, # ì¸ë±ìŠ¤ 5
    ...
]

# ì‚¬ìš©ìê°€ ì•Œì•„ì•¼ í•  ê²ƒ:
# 1. node_1ì´ ì–´ë–¤ ë…¸ë“œì¸ì§€
# 2. Q2ê°€ ëª‡ ë²ˆì§¸ ì¸ë±ìŠ¤ì¸ì§€ (0? 2?)
# 3. A2ê°€ ëª‡ ë²ˆì§¸ ì¸ë±ìŠ¤ì¸ì§€ (1? 3?)
# 4. split_index = 4 (A2 ë‹¤ìŒì´ 4)

/split node_1 4  # ë³µì¡!
```

#### ë¬¸ì œ 2: UI ë³µì¡ë„

**ë°©ì‹ A (ì›¹ UI)**:
```javascript
// íŠ¸ë¦¬ ì‹œê°í™”
node_Q1A1
  â†“
node_Q2A2  â† í´ë¦­
  â†“
node_Q3A3

// ì‚¬ìš©ì ì•¡ì…˜
1. node_Q2A2 í´ë¦­
2. "ì—¬ê¸°ì— ìƒˆ ëŒ€í™” ì¶”ê°€" ë²„íŠ¼ í´ë¦­
3. ëŒ€í™” ì…ë ¥
4. node_Q3A3ê°€ ìë™ìœ¼ë¡œ ì•„ë˜ë¡œ ì´ë™

// ì§ê´€ì !
```

**ë°©ì‹ B (ì›¹ UI)**:
```javascript
// íŠ¸ë¦¬ ì‹œê°í™”
node_1 (í¼ì¹˜ê¸°)
  â”œâ”€ Q1, A1
  â”œâ”€ Q2, A2  â† ì—¬ê¸° í´ë¦­?
  â”œâ”€ Q3, A3
  â””â”€ Q4, A4

// ì‚¬ìš©ì ì•¡ì…˜
1. node_1 í¼ì¹˜ê¸°
2. A2 ë©”ì‹œì§€ í´ë¦­ (ë…¸ë“œê°€ ì•„ë‹ˆë¼ ë©”ì‹œì§€!)
3. "ì—¬ê¸°ì„œ ë¶„í• " ë²„íŠ¼ í´ë¦­
4. ë…¸ë“œ ë¶„í•  í™•ì¸
5. ìƒˆ ëŒ€í™” ì…ë ¥
6. ì¬ì—°ê²° í™•ì¸

// ë³µì¡!
```

#### ë¬¸ì œ 3: ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬

```python
# ë°©ì‹ A
def reparent(target_id, new_parent_id):
    # ê°„ë‹¨í•œ ì¡°ìƒ ì²´í¬
    if is_ancestor(new_parent_id, target_id):
        raise CircularReferenceError()

# ë°©ì‹ B
def split_and_insert(node_id, split_index, ...):
    # 1. split ì „ì— ê²€ì‚¬? (ì•„ì§ ìƒˆ ë…¸ë“œ ì—†ìŒ)
    # 2. split í›„ì— ê²€ì‚¬? (ì´ë¯¸ íŠ¸ë¦¬ ë³€ê²½ë¨)
    # 3. rollback í•„ìš”? (ë³µì¡!)

    # ë” ë³µì¡í•œ ê²€ì‚¬ ë¡œì§ í•„ìš”
```

#### ë¬¸ì œ 4: ì—ëŸ¬ ì²˜ë¦¬

```python
# ë°©ì‹ A
try:
    reparent("node_X", "node_Y")
except NodeNotFoundError:
    print("ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
except CircularReferenceError:
    print("ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•©ë‹ˆë‹¤")

# ë¡¤ë°± ë¶ˆí•„ìš” (ì•„ë¬´ê²ƒë„ ë³€ê²½ ì•ˆ ë¨)

# ë°©ì‹ B
try:
    split_and_insert("node_1", 4, ...)
except IndexError:
    print("ì˜ëª»ëœ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤")
    # ë¡¤ë°± í•„ìš”!
    # ì´ë¯¸ ìƒì„±ëœ front_node, back_node ì‚­ì œ
    # ì›ë³¸ node_1 ë³µêµ¬
    # ìì‹ë“¤ì˜ parent_id ë³µêµ¬
except CircularReferenceError:
    print("ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•©ë‹ˆë‹¤")
    # ë¡¤ë°± í•„ìš”!
```

#### ë¬¸ì œ 5: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í­ì¦

**ë°©ì‹ A í…ŒìŠ¤íŠ¸**:
```python
test_insert_after_first_node()
test_insert_after_middle_node()
test_insert_after_last_node()
test_circular_reference()
test_node_not_found()

# 5ê°œ í…ŒìŠ¤íŠ¸
```

**ë°©ì‹ B í…ŒìŠ¤íŠ¸**:
```python
test_split_at_beginning()
test_split_at_middle()
test_split_at_end()
test_split_invalid_index()
test_split_empty_node()
test_split_single_message()
test_insert_after_split()
test_circular_reference_after_split()
test_rollback_on_error()
test_child_reparenting()

# 10+ ê°œ í…ŒìŠ¤íŠ¸
```

---

## ìµœì¢… ë¹„êµí‘œ

| ì¸¡ë©´ | ë°©ì‹ A (1í„´=1ë…¸ë“œ) | ë°©ì‹ B (ë¶„í•  ê°€ëŠ¥) |
|------|-------------------|-------------------|
| **ìë£Œêµ¬ì¡° ê°€ëŠ¥ì„±** | âœ… ê°€ëŠ¥ (ì´ë¯¸ ìª¼ê°œì ¸ ìˆìŒ) | âœ… ê°€ëŠ¥ (split ì—°ì‚°) |
| **êµ¬í˜„ ë³µì¡ë„** | â­â­ ê°„ë‹¨ | â­â­â­â­â­ ë³µì¡ |
| **ì¸ë±ìŠ¤ ê³„ì‚°** | ë¶ˆí•„ìš” (ë…¸ë“œ IDë§Œ) | í•„ìˆ˜ (ì¸ë±ìŠ¤ ê³„ì‚°) |
| **UI ì§ê´€ì„±** | â­â­â­â­â­ ì§ê´€ì  | â­â­ ë³µì¡ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ê°„ë‹¨ (ë¡¤ë°± ë¶ˆí•„ìš”) | ë³µì¡ (ë¡¤ë°± í•„ìš”) |
| **í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤** | 5ê°œ | 10+ ê°œ |
| **ì½”ë“œ ë¼ì¸ ìˆ˜** | ~30ì¤„ | ~100ì¤„ |
| **ë²„ê·¸ ìœ„í—˜** | ë‚®ìŒ | ë†’ìŒ |

---

## ê²°ë¡ 

### ìë£Œêµ¬ì¡°ì  ê°€ëŠ¥ì„±: âœ… ë‘˜ ë‹¤ ê°€ëŠ¥

- **ë°©ì‹ A**: ì´ë¯¸ ìª¼ê°œì ¸ ìˆìŒ (ë¶„í•  ë¶ˆí•„ìš”)
- **ë°©ì‹ B**: split ì—°ì‚°ìœ¼ë¡œ ìª¼ê°¤ ìˆ˜ ìˆìŒ

### ì‹¤ìš©ì„±: ë°©ì‹ Aê°€ ì••ë„ì  ìš°ìœ„

**ë°©ì‹ Aì˜ ìš°ìˆ˜ì„±**:
1. **ê°œë…ì  ë‹¨ìˆœí•¨**: ë…¸ë“œ = 1í„´, ì´ë¯¸ ìµœì†Œ ë‹¨ìœ„
2. **êµ¬í˜„ ê°„ë‹¨í•¨**: parent_id ë³€ê²½ë§Œ
3. **ì‚¬ìš©ì ê²½í—˜**: ë…¸ë“œ í´ë¦­ â†’ ë“œë˜ê·¸ ì•¤ ë“œë¡­
4. **ìœ ì§€ë³´ìˆ˜**: ì ì€ ì½”ë“œ, ì ì€ ë²„ê·¸

**ë°©ì‹ Bì˜ ë¬¸ì œì **:
1. **ê°œë…ì  ë³µì¡í•¨**: ë…¸ë“œ ë‚´ë¶€ ì¸ë±ìŠ¤ ê³„ì‚°
2. **êµ¬í˜„ ë³µì¡í•¨**: split + insert + reparent + rollback
3. **ì‚¬ìš©ì ê²½í—˜**: ì¸ë±ìŠ¤ ì§€ì •, í™•ì¸ ë‹¨ê³„ ì¦ê°€
4. **ìœ ì§€ë³´ìˆ˜**: ë§ì€ ì½”ë“œ, ë§ì€ ë²„ê·¸ ê°€ëŠ¥ì„±

---

## ìµœì¢… ê¶Œê³ 

### ë°©ì‹ A ì±„íƒ

**ì´ìœ **:
- ìë£Œêµ¬ì¡°ì ìœ¼ë¡œ ë°©ì‹ Bë„ ê°€ëŠ¥í•˜ì§€ë§Œ
- **ì‹¤ìš©ì„±ì€ ë°©ì‹ Aê°€ ì›”ë“±í•¨**
- "ê°€ëŠ¥í•˜ë‹¤" â‰  "ì¢‹ë‹¤"

**ë¹„ìœ **:
```
ë°©ì‹ B = ì¹¼ë¡œ ìŠ¤í…Œì´í¬ ìë¥´ê¸°
- ê°€ëŠ¥ì€ í•¨
- í•˜ì§€ë§Œ ë³µì¡í•˜ê³  ìœ„í—˜í•¨

ë°©ì‹ A = ì´ë¯¸ ì˜ë¦° ìŠ¤í…Œì´í¬
- ê·¸ëƒ¥ í¬í¬ë¡œ ì°ìœ¼ë©´ ë¨
- ê°„ë‹¨í•˜ê³  ì•ˆì „í•¨
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ë” ì´ìƒ ë…¼ì˜ ë¶ˆí•„ìš”

**ì§ˆë¬¸**: "ë°©ì‹ Bì—ì„œ ë¬¼ë¦¬ì ìœ¼ë¡œ ìª¼ê°¤ ìˆ˜ ìˆëŠëƒ?"
**ë‹µë³€**: âœ… ê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ âŒ ì‹¤ìš©ì ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ì´ì œ Phase CLI-1 ê°œë°œ ì‹œì‘í•˜ë©´ ë©ë‹ˆë‹¤**
- âœ… ë°©ì‹ A (1í„´ = 1ë…¸ë“œ) ìµœì¢… í™•ì •
- âœ… ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ ì™„ë£Œ
- âœ… êµ¬í˜„ ë°©ë²• ëª…í™•í•¨
- ğŸš€ ê°œë°œ ì‹œì‘!