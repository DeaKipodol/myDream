# 기능 목록 및 테스트 시나리오

**작성일**: 2025-12-02
**Phase**: CLI-1 완료 전 검증 문서
**목적**: 구현된 모든 기능의 목록화 및 체계적 테스트 가이드

---

## 📋 1. 전체 기능 목록

### 1.1 Core System (Days 1-3)

#### A. Node & Tree 데이터 구조
- **기능**: 대화를 트리 구조로 저장
- **구현 파일**: `core/models.py`
- **핵심 기능**:
  - Node 생성 (ID, 질문, 답변, 타임스탬프, 메타데이터)
  - Tree 연산 (자식 추가, 경로 탐색, 노드 검색)
  - 부모-자식 관계 관리
- **검증 방법**: `tests/test_models.py` (36 tests)

#### B. Store (상태 관리)
- **기능**: 전체 대화 트리 상태 관리
- **구현 파일**: `core/store.py`
- **핵심 기능**:
  - 현재 노드 추적
  - 노드 전환 (switch_to_node)
  - 체크포인트 저장/로드/삭제
  - 트리 상태 영속성
- **검증 방법**: `tests/test_store.py` (22 tests)

#### C. ConversationManager
- **기능**: 대화 흐름 자동 관리
- **구현 파일**: `core/conversation.py`
- **핵심 기능**:
  - turn() 메서드로 자동 노드 생성
  - 현재 위치에서 자식 노드 자동 추가
  - 대화 컨텍스트 생성
- **검증 방법**: `tests/test_conversation.py` (17 tests)

#### D. Path Utils
- **기능**: 경로 전환 유틸리티
- **구현 파일**: `core/path_utils.py`
- **핵심 기능**:
  - 공통 조상 찾기
  - 경로 비교
  - 부모/자식 관계 검증
- **검증 방법**: `tests/test_path_utils.py` (15 tests)

#### E. Checkpoint System
- **기능**: 노드에 이름표 붙이기
- **구현 파일**: `core/checkpoint.py`
- **핵심 기능**:
  - 체크포인트 생성/삭제/이름변경
  - 체크포인트 검증
  - 통계 (평균 깊이, 분기점 개수 등)
  - 고아 체크포인트 정리
- **검증 방법**: `tests/test_checkpoint.py` (19 tests)

---

### 1.2 CLI 기본 기능 (Day 4)

#### A. REPL 메인 루프
- **기능**: 대화형 명령어 인터페이스
- **구현 파일**: `cli/cli.py`
- **핵심 기능**:
  - 명령어 파싱 (슬래시 선택적)
  - 명령어 라우팅
  - 에러 처리
- **테스트 방법**: 수동 실행

#### B. 기본 명령어
| 명령어 | 기능 | 구현 메서드 |
|--------|------|-------------|
| `/ask` | AI에게 질문 (새 노드 생성) | `cmd_ask()` |
| `/turn` | 수동 대화 턴 생성 | `cmd_turn()` |
| `/show` | 현재 대화 내용 표시 | `cmd_show()` |
| `/tree` | 트리 전체 시각화 | `cmd_tree()` |
| `/switch` | 특정 노드로 이동 | `cmd_switch()` |
| `/checkpoint` | 체크포인트 관리 | `cmd_checkpoint()` |
| `/help` | 도움말 표시 | `cmd_help()` |
| `/quit` | 프로그램 종료 | `cmd_quit()` |

#### C. 트리 시각화
- **기능**: 대화 트리를 ASCII 아트로 표시
- **핵심 기능**:
  - 계층 구조 표시 (들여쓰기)
  - 현재 위치 강조 (`👉`)
  - 체크포인트 표시 (`[이름]`)
  - 노드 번호 표시 (n1, n2, ...)

---

### 1.3 추가 개발 기능 (Additional Requirements)

#### A. 노드 번호 시스템
- **기능**: UUID 대신 n1, n2, n3... 형식으로 노드 참조
- **구현 위치**: `cli/cli.py` - `_build_node_index()`
- **핵심 기능**:
  - 전위 순회(pre-order)로 번호 부여
  - 노드 번호↔ID 매핑
  - 명령어에서 n1 형식 입력 허용
- **영향 받는 명령어**: `/switch`, `/checkpoint`

#### B. 분기 자동 체크포인트 ⭐
- **기능**: 노드에 2번째 자식이 생길 때 자동으로 체크포인트 생성
- **구현 위치**: `cli/cli.py` - `_auto_checkpoint_on_branch()`
- **핵심 기능**:
  - 분기 감지 (자식 개수 >= 2)
  - 자동 이름 생성 (`@branch_질문내용`)
  - 중복 방지 (이미 체크포인트 있으면 스킵)
  - 사용자 알림 메시지
- **트리거**: `cmd_ask()`, `cmd_turn()` 실행 후
- **검증 방법**: `test_branch_auto_checkpoint.py`

#### C. Navigation History ⭐⭐
- **기능**: 노드 이동 이력 추적 및 되돌아가기
- **구현 위치**: `cli/cli.py`
- **핵심 기능**:
  1. **이력 저장**:
     - `_save_navigation_history()` 헬퍼 메서드
     - 타임스탬프, 노드 ID, 질문 내용 저장
     - 최근 20개만 유지 (자동 정리)
     - 루트 노드 제외
  2. **back 명령어**:
     - 직전 위치로 복귀
     - 이력이 없으면 에러 메시지
  3. **visits 명령어**:
     - 최근 10개 방문 이력 표시
     - 상대 시간 표시 ("방금 전", "5분 전")
- **저장 시점**:
  - `cmd_switch()` 실행 시
  - `_checkpoint_load()` 실행 시 (버그 수정됨)
- **검증 방법**: `test_navigation_history.py`, `test_checkpoint_history_bug.py`

#### D. AI 통합
- **기능**: OpenAI API를 통한 실제 AI 응답 생성
- **구현 파일**: `ai/client.py`
- **핵심 기능**:
  - 대화 컨텍스트 전달 (경로상의 모든 대화)
  - API 키 검증
  - 에러 처리 (네트워크, 인증 등)
  - 선택적 기능 (키 없어도 CLI 동작)
- **환경 변수**: `OPENAI_API_KEY`
- **테스트 필요**: `tests/test_ai_client.py` (미작성 - PM 필수 요구사항)

#### E. UI 개선사항
1. **3-섹션 체크포인트 목록**:
   - 수동 체크포인트 / 분기 체크포인트 / 방문 기록
   - 각 섹션 헤더와 구분선
2. **슬래시 선택적 명령어**:
   - `help`, `/help` 둘 다 허용
3. **부분 ID 매칭**:
   - 체크포인트 이름 앞부분만 입력해도 자동 매칭

---

### 1.4 버그 수정

#### 체크포인트 로드 시 이력 미저장 버그
- **문제**: `checkpoint load`는 이력을 저장하지 않아 `back` 명령 실패
- **원인**: `cmd_switch()`에만 이력 저장 코드가 있었고 `_checkpoint_load()`에는 없었음
- **해결책**:
  - `_save_navigation_history()` 헬퍼 메서드 추출
  - 두 메서드 모두에서 호출
  - DRY 원칙 적용, SRP 준수
- **검증**: `test_checkpoint_history_bug.py` ✅

---

## 🧪 2. 테스트 시나리오

### 2.1 기존 시나리오 (Scenarios 1-3) ✅

#### Scenario 1: 기본 대화 흐름
```
1. CLI 시작
2. /ask "Python이 뭐야?"
3. /show → 대화 내용 확인
4. /tree → 트리 구조 확인 (n1 노드)
5. /ask "Django는?"
6. /tree → n1 → n2 구조 확인
```
**검증**: ✅ 통과 (Day 4)

#### Scenario 2: 분기 생성
```
1. n1, n2 노드 생성
2. /switch n1 → n1로 이동
3. /turn "React는?" "React는..." → n3 생성 (n1의 2번째 자식)
4. /tree → 분기 구조 확인
   n1
   ├── n2
   └── n3
```
**검증**: ✅ 통과 (Day 4)

#### Scenario 3: 체크포인트
```
1. n1, n2 노드 생성
2. /checkpoint save cp1 → n2에 체크포인트
3. /switch n1
4. /checkpoint load cp1 → n2로 복귀
5. /checkpoint list → 체크포인트 목록 확인
```
**검증**: ✅ 통과 (Day 4)

---

### 2.2 추가 시나리오 (Scenarios 4-5) ❌ 미실행

#### Scenario 4: 대규모 트리 및 분기 자동 체크포인트
**목적**: 복잡한 트리에서 자동 체크포인트와 이동 기능 검증

**단계**:
```
1. 10개 노드로 구성된 복잡한 트리 생성:
   root
   ├── n1 "Python?"
   │   ├── n2 "Django?"
   │   │   └── n3 "REST API?"
   │   └── n4 "Flask?"  ← 분기! @branch_Python 자동 생성
   │       └── n5 "Blueprint?"
   ├── n6 "JavaScript?"
   │   ├── n7 "React?"
   │   │   └── n8 "Hooks?"
   │   └── n9 "Vue?"  ← 분기! @branch_JavaScript 자동 생성
   └── n10 "데이터베이스?"

2. 자동 체크포인트 검증:
   - /checkpoint list → @branch_Python, @branch_JavaScript 존재 확인
   - 각 분기점 노드(n1, n6)에 체크포인트 생성되었는지 확인

3. 깊은 경로 탐색:
   - /switch n8 → n1 → n6 → n7 → n8 경로 이동
   - /show → Hooks 질문 내용 확인
   - /tree → 현재 위치 표시 확인

4. 체크포인트 이동:
   - /checkpoint load @branch_Python → n1로 이동
   - /tree → 위치 확인
   - /checkpoint load @branch_JavaScript → n6으로 이동
   - /tree → 위치 확인

5. 통계 확인:
   - /checkpoint list
   - 평균 깊이 계산 확인 (n1: depth 1, n6: depth 1 → avg 1.0)
```

**예상 결과**:
- ✅ 모든 분기점에 자동 체크포인트 생성
- ✅ 체크포인트로 정확히 이동
- ✅ 트리 시각화가 올바르게 표시됨
- ✅ 노드 번호(n1~n10)가 전위 순회 순서대로 부여됨

**검증 포인트**:
- 분기 자동 체크포인트 기능
- 체크포인트 통계 (평균 깊이)
- 노드 번호 시스템
- 트리 시각화 정확도

---

#### Scenario 5: Navigation History 및 엣지 케이스
**목적**: 이동 이력, back 명령, 20개 제한 검증

**단계**:

**Part A: 기본 이력 기능**
```
1. 노드 3개 생성 (n1, n2, n3)
2. /switch n1 → n2에서 n1로 이동 (n2 이력 저장)
3. /visits → n2 이력 1개 확인
4. /switch n3 → n1에서 n3로 이동 (n1 이력 저장)
5. /visits → n2, n1 이력 2개 확인 (시간순)
6. /back → n1으로 복귀
7. /back → n2로 복귀
8. /back → 이력 없음 에러 메시지
```

**Part B: 체크포인트 로드 이력 (버그 수정 검증)**
```
1. n1, n2, n3 노드 생성
2. /checkpoint save cp1 → n3에 체크포인트
3. /switch n1
4. /turn "n4" "..." → n4 생성 (분기, n1에서)
5. /checkpoint load cp1 → n3로 이동
6. /visits → n4 이력이 저장되었는지 확인 ⭐
7. /back → n4로 돌아가는지 확인 ⭐
```

**Part C: 20개 제한 및 오버플로우**
```
1. 22개 노드를 순차적으로 생성 (n1~n22)
2. 각 노드를 차례로 방문 (switch로 22번 이동)
3. /visits → 최근 10개만 표시 확인
4. 이력 내부 확인 → 최근 20개만 유지되었는지 확인
   (처음 2개 노드는 자동 삭제됨)
5. /back 20번 실행 → 정상 동작
6. /back 21번째 실행 → 에러 메시지 (이력 부족)
```

**Part D: 루트 노드 제외**
```
1. CLI 시작 (root에 위치)
2. /turn "n1" "..." → n1 생성 및 자동 이동
3. /switch root → root로 이동
4. /visits → root는 이력에 없어야 함
5. /back → n1으로 복귀 (root 스킵)
```

**Part E: 상대 시간 표시**
```
1. 노드 생성 후 즉시 이동
2. /visits → "방금 전" 표시 확인
3. 1분 대기
4. /visits → "1분 전" 표시 확인
5. 5분 대기
6. /visits → "6분 전" 표시 확인
```

**예상 결과**:
- ✅ back 명령으로 정확히 이전 위치로 복귀
- ✅ 체크포인트 로드 시 이력 저장 (버그 수정됨)
- ✅ 20개 제한 자동 적용
- ✅ 루트 노드는 이력에 저장되지 않음
- ✅ 상대 시간 포맷 정상 작동

**검증 포인트**:
- Navigation history 기능 전체
- 버그 수정 (체크포인트 로드 이력)
- 엣지 케이스 처리 (오버플로우, 루트 제외)
- UI 포맷 (시간 표시)

---

### 2.3 AI 통합 테스트 (Scenario 6) ❌ 미작성

#### Scenario 6: OpenAI API 통합
**목적**: AI 클라이언트 기능 검증

**전제 조건**: `OPENAI_API_KEY` 환경 변수 설정

**단계**:
```
1. 환경 변수 설정:
   export OPENAI_API_KEY="sk-..."

2. CLI 시작 및 API 키 인식 확인

3. 첫 질문:
   /ask "Python이란?" → AI 응답 생성 확인

4. 연속 대화 (컨텍스트 유지):
   /ask "그럼 Django는?" → 이전 대화 참조한 응답 확인

5. 분기 후 컨텍스트:
   /switch n1
   /ask "Flask는?" → Python 질문부터의 컨텍스트 전달 확인

6. 에러 처리:
   - 잘못된 API 키로 재시작 → 에러 메시지 확인
   - 네트워크 없이 실행 → 에러 처리 확인
```

**필요 작업**:
- `tests/test_ai_client.py` 작성 (PM 필수 요구사항)
- Mock API 응답 테스트
- 에러 케이스 테스트

---

## 📊 3. 테스트 현황 요약

| 영역 | 테스트 파일 | 테스트 수 | 상태 |
|------|------------|-----------|------|
| Core: Models | `test_models.py` | 36 | ✅ 통과 |
| Core: Store | `test_store.py` | 22 | ✅ 통과 |
| Core: Conversation | `test_conversation.py` | 17 | ✅ 통과 |
| Core: Path Utils | `test_path_utils.py` | 15 | ✅ 통과 |
| Core: Checkpoint | `test_checkpoint.py` | 19 | ✅ 통과 |
| CLI: 기본 (수동) | Scenarios 1-3 | 3 | ✅ 통과 |
| CLI: 분기 자동 CP | `test_branch_auto_checkpoint.py` | 1 | ✅ 통과 |
| CLI: Navigation | `test_navigation_history.py` | 1 | ✅ 통과 |
| Bug Fix: CP 로드 | `test_checkpoint_history_bug.py` | 1 | ✅ 통과 |
| **CLI: 대규모 트리** | **`test_scenario_4.py`** | **1** | **✅ 통과** |
| **CLI: 엣지 케이스** | **`test_scenario_5.py`** | **5 (Parts A-E)** | **✅ 통과** |
| **AI: API 통합** | **`test_ai_client.py`** | **-** | **❌ 미작성** |

**합계**: 109 unit tests ✅ + 3 integration tests ✅ + 6 feature tests ✅

**미완료**: AI 통합 테스트 (PM 필수 요구사항)

---

## 🎯 4. 다음 단계 (테스트 우선순위)

### 우선순위 1 (필수): Scenario 4-5 수동 실행
- [ ] Scenario 4: 대규모 트리 생성 및 분기 자동 체크포인트 검증
- [ ] Scenario 5: Navigation history 전체 기능 및 엣지 케이스 검증
- [ ] 각 시나리오 실행 결과 문서화

### 우선순위 2 (PM 필수): AI 통합 테스트
- [ ] `tests/test_ai_client.py` 작성
- [ ] Mock API 응답 테스트
- [ ] 에러 처리 테스트
- [ ] Scenario 6 수동 실행 (실제 API 키 사용)

### 우선순위 3 (권장): 추가 유닛 테스트
- [ ] Node 번호 시스템 테스트 (PM 권장)
- [ ] 부분 ID 매칭 테스트
- [ ] 슬래시 선택적 파싱 테스트

### 우선순위 4: Day 5.2-5.3
- [ ] README_CLI.md 작성 (사용자 가이드)
- [ ] Docstring 보완
- [ ] 타입 힌트 점검
- [ ] 코드 포매팅 (black, isort)

---

## 📝 5. 테스트 체크리스트

### Scenario 4 체크리스트
- [ ] 10개 노드 트리 생성 완료
- [ ] 2개 분기점에 자동 체크포인트 생성 확인
- [ ] 체크포인트 이름 형식 검증 (@branch_질문내용)
- [ ] 체크포인트 목록에 수동/자동 구분 표시 확인
- [ ] 체크포인트로 정확히 이동 가능
- [ ] 노드 번호(n1~n10) 전위 순회 순서 확인
- [ ] 트리 시각화 정확도 확인
- [ ] 체크포인트 통계 (평균 깊이) 계산 정확도 확인

### Scenario 5 체크리스트
- [ ] switch로 이동 시 이력 저장
- [ ] checkpoint load로 이동 시 이력 저장 (버그 수정)
- [ ] back 명령으로 이전 위치 복귀
- [ ] 이력 없을 때 back 에러 메시지
- [ ] visits 명령으로 최근 10개 표시
- [ ] 22번 이동 시 최근 20개만 유지 (앞 2개 자동 삭제)
- [ ] 루트 노드는 이력에 저장 안 됨
- [ ] 상대 시간 표시 확인 ("방금 전", "N분 전")

### Scenario 6 체크리스트 (AI 통합)
- [ ] API 키 인식 확인
- [ ] AI 응답 생성 확인
- [ ] 대화 컨텍스트 전달 확인
- [ ] 분기 후 컨텍스트 유지 확인
- [ ] 잘못된 API 키 에러 처리
- [ ] 네트워크 에러 처리
- [ ] API 키 없이도 CLI 기본 기능 동작

---

## 결론

현재 **109개 유닛 테스트**와 **기본 통합 테스트(Scenarios 1-3)**는 모두 통과했으나, **고급 기능 검증(Scenarios 4-5)**과 **AI 통합 테스트(Scenario 6)**가 누락되었습니다.

Phase CLI-1 완료를 위해 다음 작업이 필수적입니다:
1. ✅ Scenario 4-5 수동 실행 및 결과 문서화
2. ✅ AI 통합 테스트 작성 및 실행
3. ✅ README_CLI.md 작성
4. ✅ 최종 코드 정리

모든 기능이 의도대로 동작하는지 체계적으로 검증한 후 PM 최종 검토를 받아야 합니다.
