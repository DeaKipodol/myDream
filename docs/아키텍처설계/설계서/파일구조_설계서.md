# 파일구조 설계서
- 작성일: 2025-11-05
- 설계자: 아키텍처 설계자
- 상태: 초안
- 버전: 1.0

## 1. 파일 구조 원칙

### 1.1 파일 크기 규칙
- **최대 크기**: 1,000줄
- **이상적 크기**: 200줄
- **초과 시**: 반드시 분리

### 1.2 클래스 수 규칙
- **이상적**: 1-3개 클래스/파일
- **경고**: 5개 이상 클래스 → 분리 고려
- **예외**: 관련 DTO/모델 세트는 가능

### 1.3 분리 기준
- 단일 책임 원칙(SRP) 위반 시
- 응집도 낮을 때
- 재사용 가능성 높을 때
- 테스트 가능성 향상 시
- **단, 과도한 분리 금지**

### 1.4 명명 규칙
- **명확한 역할 표현**: `UserRepository.py`, `PathSwitchService.py`
- **불명확 금지**: `utils.py`, `helpers.py`
- **PascalCase**: 클래스명
- **snake_case**: 함수명, 변수명
- **UPPER_CASE**: 상수

## 2. 프로젝트 전체 디렉토리 구조

```
myDream/
├── frontend/                    # 프론트엔드 (HTML/CSS/JS)
│   ├── index.html               # 메인 페이지
│   ├── css/
│   │   ├── reset.css            # CSS 리셋
│   │   ├── layout.css           # 레이아웃 스타일
│   │   ├── tree-view.css        # TreeView 스타일
│   │   ├── chat-view.css        # ChatView 스타일
│   │   └── components.css       # 공통 컴포넌트
│   ├── js/
│   │   ├── main.js              # 진입점 (200줄 이하)
│   │   ├── state/
│   │   │   └── StateManager.js  # 전역 상태 관리 (300줄)
│   │   ├── components/
│   │   │   ├── TreeView.js      # 트리 뷰 (400줄)
│   │   │   ├── ChatView.js      # 대화 패널 (300줄)
│   │   │   ├── Breadcrumbs.js   # 경로 표시 (150줄)
│   │   │   └── CheckpointList.js # 체크포인트 (250줄)
│   │   ├── services/
│   │   │   └── ApiService.js    # API 호출 (400줄)
│   │   └── utils/
│   │       ├── dom.js           # DOM 유틸 (150줄)
│   │       └── validators.js    # 검증 (100줄)
│   └── assets/
│       └── icons/               # 아이콘 파일
│
├── backend/                     # 백엔드 (Python/FastAPI)
│   ├── main.py                  # FastAPI 진입점 (100줄)
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings.py          # 환경 설정 (150줄)
│   │   └── database.py          # DB 연결 (100줄)
│   ├── api/
│   │   ├── __init__.py
│   │   ├── dependencies.py      # 의존성 주입 (100줄)
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── conversations.py # 대화 API (300줄)
│   │       ├── paths.py         # 경로 API (250줄)
│   │       ├── checkpoints.py   # 체크포인트 API (200줄)
│   │       └── ai.py            # AI API (200줄)
│   ├── domain/
│   │   ├── __init__.py
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── conversation.py  # 대화 모델 (150줄)
│   │   │   ├── node.py          # 노드 모델 (150줄)
│   │   │   ├── checkpoint.py    # 체크포인트 모델 (100줄)
│   │   │   └── shelf.py         # 보존 영역 모델 (80줄)
│   │   ├── services/
│   │   │   ├── __init__.py
│   │   │   ├── conversation_service.py     # 대화 서비스 (300줄)
│   │   │   ├── path_switch_service.py      # 경로 전환 (400줄)
│   │   │   ├── lca_service.py              # LCA 계산 (300줄)
│   │   │   ├── checkpoint_service.py       # 체크포인트 (250줄)
│   │   │   ├── snapshot_service.py         # 스냅샷 (200줄)
│   │   │   ├── shelf_service.py            # 보존 영역 (150줄)
│   │   │   ├── ai_service.py               # AI 통합 (300줄)
│   │   │   └── context_builder.py          # 컨텍스트 구성 (200줄)
│   │   └── algorithms/
│   │       ├── __init__.py
│   │       ├── lca_linear.py    # 선형 LCA (150줄)
│   │       └── lca_binary_lifting.py # Binary Lifting (250줄)
│   ├── infrastructure/
│   │   ├── __init__.py
│   │   ├── repositories/
│   │   │   ├── __init__.py
│   │   │   ├── conversation_repository.py  # 대화 레포 (250줄)
│   │   │   ├── node_repository.py          # 노드 레포 (300줄)
│   │   │   ├── checkpoint_repository.py    # 체크포인트 레포 (200줄)
│   │   │   └── shelf_repository.py         # 보존 영역 레포 (150줄)
│   │   ├── cache/
│   │   │   ├── __init__.py
│   │   │   ├── redis_cache.py   # Redis 캐시 (200줄)
│   │   │   └── memory_cache.py  # 인메모리 캐시 (150줄)
│   │   └── ai_providers/
│   │       ├── __init__.py
│   │       ├── base.py          # AI 프로바이더 인터페이스 (100줄)
│   │       ├── openai_provider.py # OpenAI 구현 (250줄)
│   │       └── anthropic_provider.py # Anthropic 구현 (250줄)
│   ├── shared/
│   │   ├── __init__.py
│   │   ├── schemas/
│   │   │   ├── __init__.py
│   │   │   ├── conversation.py  # 요청/응답 스키마 (200줄)
│   │   │   ├── path.py          # 경로 스키마 (150줄)
│   │   │   └── checkpoint.py    # 체크포인트 스키마 (100줄)
│   │   ├── exceptions.py        # 커스텀 예외 (150줄)
│   │   ├── constants.py         # 상수 (100줄)
│   │   └── utils/
│   │       ├── __init__.py
│   │       ├── hashing.py       # 해시 유틸 (80줄)
│   │       └── validators.py    # 검증 유틸 (100줄)
│   └── tests/
│       ├── unit/
│       │   ├── test_lca_service.py
│       │   ├── test_path_switch.py
│       │   └── test_checkpoint_service.py
│       ├── integration/
│       │   ├── test_api_conversations.py
│       │   └── test_api_paths.py
│       └── e2e/
│           └── test_full_flow.py
│
├── docs/                        # 문서
│   ├── 아키텍처설계/
│   │   ├── 요구사항_정리.md
│   │   ├── 아키텍처_설계서.md
│   │   ├── 파일구조_설계서.md
│   │   └── 개발자지시서/
│   │       ├── 프론트엔드_지시서.md
│   │       └── 백엔드_지시서.md
│   └── api/
│       └── openapi.yaml          # OpenAPI 스펙
│
├── deployment/                   # 배포 설정
│   ├── docker/
│   │   ├── Dockerfile.backend
│   │   ├── Dockerfile.frontend
│   │   └── docker-compose.yml
│   ├── kubernetes/
│   │   ├── deployment.yaml
│   │   └── service.yaml
│   └── ci-cd/
│       └── .github/
│           └── workflows/
│               ├── backend-ci.yml
│               └── frontend-ci.yml
│
├── scripts/                      # 유틸 스크립트
│   ├── seed_data.py             # 시드 데이터 생성
│   └── migrate_db.py            # DB 마이그레이션
│
├── .gitignore
├── README.md
└── requirements.txt             # Python 의존성
```

## 3. 프론트엔드 파일 상세

### 3.1 main.js (진입점)
**역할**: 앱 초기화, 컴포넌트 마운트
**크기**: 200줄 이하
**책임**:
- StateManager 초기화
- 컴포넌트 인스턴스 생성 및 마운트
- 이벤트 리스너 등록
```javascript
// 예시 구조
import StateManager from './state/StateManager.js';
import TreeView from './components/TreeView.js';
import ChatView from './components/ChatView.js';

class App {
  constructor() {
    this.state = new StateManager();
    this.treeView = new TreeView(this.state);
    this.chatView = new ChatView(this.state);
  }

  init() {
    this.treeView.mount('#tree-container');
    this.chatView.mount('#chat-container');
    this.setupEventListeners();
  }

  setupEventListeners() {
    // 이벤트 리스너 등록
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const app = new App();
  app.init();
});
```

### 3.2 StateManager.js (전역 상태)
**역할**: 앱 상태 관리, 옵저버 패턴
**크기**: 300줄
**책임**:
- activePath, selectedNode, checkpoints 등 상태 보관
- 상태 변경 시 구독자에게 알림
- 불변성 유지
```javascript
class StateManager {
  constructor() {
    this.state = {
      activePathIds: [],
      selectedNodeId: null,
      checkpoints: [],
      shelves: [],
      uiFlags: { loading: false, warning: false }
    };
    this.listeners = [];
  }

  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  }

  setState(newState) {
    this.state = { ...this.state, ...newState };
    this.listeners.forEach(listener => listener(this.state));
  }

  getState() {
    return { ...this.state };
  }
}
```

### 3.3 TreeView.js (트리 뷰)
**역할**: 트리 구조 시각화, 노드 클릭 핸들링
**크기**: 400줄
**책임**:
- 트리 렌더링 (재귀 또는 레벨 순회)
- 노드 클릭 이벤트 → API 호출 → 상태 업데이트
- 활성 경로 하이라이트
```javascript
class TreeView {
  constructor(stateManager) {
    this.state = stateManager;
    this.container = null;
  }

  mount(selector) {
    this.container = document.querySelector(selector);
    this.state.subscribe(() => this.render());
    this.render();
  }

  render() {
    // 트리 렌더링 로직
  }

  handleNodeClick(nodeId) {
    // 경로 전환 API 호출
    // 상태 업데이트
  }
}
```

### 3.4 ApiService.js (API 호출)
**역할**: 백엔드 API 호출 추상화
**크기**: 400줄
**책임**:
- HTTP 요청 (fetch 래퍼)
- 에러 핸들링
- 재시도 로직
```javascript
class ApiService {
  constructor(baseURL) {
    this.baseURL = baseURL;
  }

  async switchPath(conversationId, currentLeafId, targetNodeId) {
    const response = await fetch(`${this.baseURL}/conversations/${conversationId}/switch`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currentLeafId, targetNodeId })
    });
    if (!response.ok) throw new Error('Path switch failed');
    return response.json();
  }

  // 기타 API 메서드...
}
```

## 4. 백엔드 파일 상세

### 4.1 main.py (FastAPI 진입점)
**역할**: FastAPI 앱 초기화, 라우터 등록
**크기**: 100줄
**책임**:
- FastAPI 인스턴스 생성
- CORS, 미들웨어 설정
- 라우터 등록
- 헬스체크 엔드포인트
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from api.v1 import conversations, paths, checkpoints, ai

app = FastAPI(title="AI Consultation API", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"]
)

# 라우터 등록
app.include_router(conversations.router, prefix="/api/v1/conversations", tags=["conversations"])
app.include_router(paths.router, prefix="/api/v1/conversations", tags=["paths"])
app.include_router(checkpoints.router, prefix="/api/v1/checkpoints", tags=["checkpoints"])
app.include_router(ai.router, prefix="/api/v1/ai", tags=["ai"])

@app.get("/healthz")
async def health_check():
    return {"status": "ok"}
```

### 4.2 api/v1/conversations.py (대화 API)
**역할**: 대화 CRUD 엔드포인트
**크기**: 300줄
**책임**:
- POST /conversations: 대화 생성
- GET /conversations/{id}: 대화 조회
- POST /conversations/{id}/nodes: 노드 추가
- 의존성 주입으로 서비스 사용
```python
from fastapi import APIRouter, Depends, HTTPException
from domain.services.conversation_service import ConversationService
from shared.schemas.conversation import ConversationCreate, ConversationResponse

router = APIRouter()

@router.post("/", response_model=ConversationResponse)
async def create_conversation(
    data: ConversationCreate,
    service: ConversationService = Depends()
):
    try:
        conversation = await service.create(data)
        return conversation
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# 기타 엔드포인트...
```

### 4.3 api/v1/paths.py (경로 API)
**역할**: 경로 전환 엔드포인트
**크기**: 250줄
**책임**:
- POST /conversations/{id}/switch: 경로 전환
- GET /conversations/{id}/nodes/{nodeId}/path: 경로 조회
```python
from fastapi import APIRouter, Depends, HTTPException
from domain.services.path_switch_service import PathSwitchService
from shared.schemas.path import PathSwitchRequest, PathSwitchResponse

router = APIRouter()

@router.post("/{conversation_id}/switch", response_model=PathSwitchResponse)
async def switch_path(
    conversation_id: str,
    data: PathSwitchRequest,
    service: PathSwitchService = Depends()
):
    try:
        result = await service.switch(conversation_id, data.currentLeafId, data.targetNodeId)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 4.4 domain/services/path_switch_service.py (경로 전환 서비스)
**역할**: 경로 전환 비즈니스 로직
**크기**: 400줄
**책임**:
- 경로 전환 조율
- LCAService, CheckpointService, ShelfService 호출
- 트랜잭션 관리
```python
from domain.services.lca_service import LCAService
from domain.services.checkpoint_service import CheckpointService
from infrastructure.repositories.node_repository import NodeRepository

class PathSwitchService:
    def __init__(self, lca_service: LCAService, checkpoint_service: CheckpointService, node_repo: NodeRepository):
        self.lca_service = lca_service
        self.checkpoint_service = checkpoint_service
        self.node_repo = node_repo

    async def switch(self, conversation_id: str, current_leaf_id: str, target_node_id: str):
        # 1. LCA 계산
        lca_id = await self.lca_service.calculate(current_leaf_id, target_node_id)

        # 2. 경로 재구성
        prefix = await self.node_repo.find_path_to_node(lca_id)
        suffix = await self.node_repo.find_path_from_node(lca_id, target_node_id)
        new_active_path = prefix + suffix[1:]  # LCA 중복 제거

        # 3. 체크포인트 생성
        # ...

        return {
            "activePathIds": new_active_path,
            "lcaNodeId": lca_id
        }
```

### 4.5 domain/services/lca_service.py (LCA 서비스)
**역할**: LCA 계산 조율
**크기**: 300줄
**책임**:
- 노드 수 임계값 확인
- 선형 vs Binary Lifting 전략 선택
- 캐시 조회/저장
```python
from domain.algorithms.lca_linear import calculate_lca_linear
from domain.algorithms.lca_binary_lifting import calculate_lca_binary_lifting
from infrastructure.cache.redis_cache import RedisCache

class LCAService:
    def __init__(self, node_repo, cache: RedisCache, threshold: int = 1000):
        self.node_repo = node_repo
        self.cache = cache
        self.threshold = threshold

    async def calculate(self, node_a_id: str, node_b_id: str) -> str:
        # 1. 캐시 확인
        cache_key = f"lca:{node_a_id}:{node_b_id}"
        cached = await self.cache.get(cache_key)
        if cached:
            return cached

        # 2. 노드 수 확인
        node_count = await self.node_repo.count_by_conversation()

        # 3. 알고리즘 선택
        if node_count < self.threshold:
            lca = await calculate_lca_linear(node_a_id, node_b_id, self.node_repo)
        else:
            lca = await calculate_lca_binary_lifting(node_a_id, node_b_id, self.node_repo)

        # 4. 캐시 저장
        await self.cache.set(cache_key, lca, ttl=900)  # 15분

        return lca
```

### 4.6 infrastructure/repositories/node_repository.py (노드 레포)
**역할**: 노드 데이터 접근
**크기**: 300줄
**책임**:
- CRUD 연산
- 경로 조회 (find_path_to_root)
- 자식 조회 (find_children)
```python
from motor.motor_asyncio import AsyncIOMotorClient
from domain.models.node import Node

class NodeRepository:
    def __init__(self, db: AsyncIOMotorClient):
        self.collection = db["nodes"]

    async def create(self, node: Node) -> Node:
        result = await self.collection.insert_one(node.dict())
        node.id = str(result.inserted_id)
        return node

    async def find_by_id(self, node_id: str) -> Node:
        doc = await self.collection.find_one({"_id": node_id})
        if not doc:
            raise ValueError(f"Node {node_id} not found")
        return Node(**doc)

    async def find_path_to_root(self, node_id: str) -> list[str]:
        path = []
        current_id = node_id
        while current_id:
            node = await self.find_by_id(current_id)
            path.insert(0, node.id)
            current_id = node.parentId
        return path
```

## 5. 파일별 책임 매트릭스

| 파일 | 레이어 | 주요 책임 | 크기 목표 | 의존성 |
|------|--------|----------|-----------|--------|
| main.js | Presentation | 앱 초기화 | 200 | StateManager, Components |
| StateManager.js | Presentation | 상태 관리 | 300 | 없음 |
| TreeView.js | Presentation | 트리 렌더링 | 400 | StateManager, ApiService |
| ChatView.js | Presentation | 대화 패널 | 300 | StateManager, ApiService |
| ApiService.js | Presentation | API 호출 | 400 | 없음 |
| main.py | Backend | FastAPI 초기화 | 100 | Routers |
| conversations.py | API | 대화 API | 300 | ConversationService |
| paths.py | API | 경로 API | 250 | PathSwitchService |
| path_switch_service.py | Business | 경로 전환 로직 | 400 | LCAService, CheckpointService |
| lca_service.py | Business | LCA 계산 | 300 | Algorithms, Cache |
| lca_linear.py | Business | 선형 LCA | 150 | NodeRepository |
| lca_binary_lifting.py | Business | Binary Lifting | 250 | NodeRepository, Cache |
| node_repository.py | Data | 노드 CRUD | 300 | MongoDB |
| checkpoint_repository.py | Data | 체크포인트 CRUD | 200 | MongoDB |

## 6. 파일 크기 초과 시 분리 전략

### 예시: TreeView.js가 700줄이 되었을 때

**분리 전:**
```
js/components/TreeView.js (700줄)
- 트리 렌더링
- 노드 클릭 핸들링
- 드래그 앤 드롭
- 키보드 탐색
- 애니메이션
```

**분리 후:**
```
js/components/TreeView/
├── TreeView.js (300줄)      # 메인 컴포넌트
├── TreeRenderer.js (200줄)  # 렌더링 로직
├── TreeInteraction.js (150줄) # 상호작용 (클릭, 드래그)
└── TreeAnimation.js (100줄) # 애니메이션
```

### 예시: path_switch_service.py가 600줄이 되었을 때

**분리 전:**
```
path_switch_service.py (600줄)
- 경로 전환
- 병합 로직
- 보존 영역 이동
```

**분리 후:**
```
domain/services/
├── path_switch_service.py (300줄)   # 메인 로직
├── path_merge_service.py (200줄)    # 병합 로직
└── shelf_manager.py (150줄)         # 보존 영역 관리
```

## 7. 금지 사항

### 7.1 금지된 파일명
- `utils.py` (역할 불명확)
- `helpers.js` (역할 불명확)
- `common.py` (너무 포괄적)
- `misc.js` (Miscellaneous는 금지)

### 7.2 금지된 구조
- **God Class**: 1개 파일에 모든 로직
- **Anemic Model**: 모델이 데이터만 담고 로직 없음 (단, DTO는 예외)
- **순환 의존성**: A → B → A

### 7.3 권장하지 않는 패턴
- 1000줄 초과 파일 방치
- 10개 이상 클래스를 한 파일에
- 3단계 이상 디렉토리 중첩 (예외: 테스트)

## 8. 검증 체크리스트

### 파일 생성 전 체크
- [ ] 파일 역할이 명확한가?
- [ ] 파일명이 역할을 정확히 표현하는가?
- [ ] 예상 코드 길이가 1000줄 이하인가?
- [ ] 이 파일이 정말 필요한가? (과도한 분리 방지)

### 파일 작성 중 체크
- [ ] 현재 줄 수가 500줄 이상인가? (경고)
- [ ] 현재 줄 수가 800줄 이상인가? (분리 고려)
- [ ] 클래스 수가 5개 이상인가? (분리 고려)
- [ ] 단일 책임 원칙을 위반하고 있는가?

### 파일 완성 후 체크
- [ ] 최종 줄 수가 1000줄 이하인가?
- [ ] 파일의 모든 함수/메서드가 응집도가 높은가?
- [ ] 이 파일을 테스트하기 쉬운가?
- [ ] 다른 파일이 이 파일에 과도하게 의존하지 않는가?

## 9. 다음 단계

1. **개발자 지시서 작성**
   - 프론트엔드 개발자에게 파일별 구현 가이드
   - 백엔드 개발자에게 파일별 구현 가이드
   - 인터페이스 계약서

2. **프로토타입 구현 시작**
   - 핵심 파일부터 구현
   - 파일 크기 모니터링
   - 코드 리뷰로 준수 확인
