# 아키텍처 팀 의견서 - LCA 의사결정

**작성일**: 2025-11-09
**작성자**: 아키텍처 설계자
**참조 문서**:
- `docs/PM_관리/PM_보고서/LCA_의사결정_가이드.md`
- `docs/초기개발/PM_보고서/03_LCA_불필요성_제안서.md`
- `plan.md`

**수신**: PM, 기술 총괄자

---

## 📋 Executive Summary

### PM 요청사항 검토 완료
- ✅ plan.md 87-92줄 분석
- ✅ 하이브리드 접근 아키텍처 일관성 검토
- ✅ 병합 기능 plan.md 명세 확인

### 아키텍처 팀 결론
**옵션 C (하이브리드 접근) 승인합니다.**

**근거**:
1. ✅ plan.md에 병합 기능 명확히 명시됨
2. ✅ 아키텍처 일관성 유지 가능
3. ✅ Phase CLI-1 단순화 타당
4. ✅ 확장성 보장

---

## 🔍 분석 결과

### 1. plan.md 87-92줄 분석

#### 질문
> "plan.md 87-92줄이 '병합' 시나리오인지 확인"

#### 분석
```markdown
# plan.md Line 87-92
1. 시스템은 현재 리프 C와 목표 T를 입력으로 받는다.
2. 시스템은 L = LCA(C, T)를 계산한다.
3. 시스템은 prefix = path(root, L)를 구성한다.
4. 시스템은 suffix = path(L, T)를 구성하되 L을 중복 배제한다.
5. 시스템은 activePath = prefix + suffix로 재구성한다.
```

#### 결론
**❌ 병합 시나리오가 아닙니다.**

**이유**:
- "activePath = prefix + suffix로 재구성" → 경로 전환
- 병합은 두 노드의 인사이트를 **결합하여 새 노드 생성**
- 87-92줄은 **단일 경로 재구성** (경로 전환 알고리즘)

**하지만**: plan.md의 **다른 부분**에 병합 기능이 명확히 명시되어 있음

---

### 2. plan.md에 명시된 병합 기능 증거

#### 증거 1: Line 38 (시나리오 4)
```markdown
시나리오 4: 사용자는 B로 돌아가기 버튼을 누른다.
시스템은 앵커 포인트를 B로 설정하고 활성 경로를 A→B로 만든다.
시스템은 B 이후의 하위 대화를 **병합 규칙에 따라 다룬다**.
시스템은 동일 조상 하위의 병합 가능한 메시지를 병합하고
충돌하는 논리는 보존 영역으로 이동한다.
```

**명확한 병합 기능 언급** ✅

---

#### 증거 2: Line 46 (개념 모델)
```markdown
개념 모델은 루트가 있는 트리를 사용한다.
...
경로 전환은 LCA를 기준으로 재구성된다.
**병합은 동일 조상 하위에서 사용자 승인 하에 제한적으로 수행된다.**
```

**병합 규칙의 명확한 정의** ✅

---

#### 증거 3: Line 55-59 (병합 규칙)
```markdown
병합 규칙은 다음과 같이 정의된다.
1. [생략]
2. 시스템은 후보 묶음을 사용자가 승인하면 **활성 경로로 병합한다.**
3. [생략]
4. 시스템은 **병합 이후 새 체크포인트를 생성한다.**
```

**병합 프로세스의 4단계 정의** ✅

---

#### 증거 4: Line 542 (구체적 시나리오)
```markdown
시스템은 사용자가 B로 돌아가기 버튼을 누르는 경우를 처리한다.
...
시스템은 **병합 가능 후보를 제안한다**.
시스템은 **사용자가 승인하면 병합을 수행한다.**
```

**사용자 승인 기반 병합 UX** ✅

---

#### 증거 5: Line 410 (AI 통합)
```markdown
**컨텍스트 병합 알고리즘**: 상위 노드들의 정보를 효과적으로 결합하여
새로운 컨텍스트를 생성합니다.
```

**AI 통합과 연계된 병합** ✅

---

### 3. 병합 기능의 핵심 요구사항

plan.md 분석 결과, 병합 기능은 다음과 같이 정의됩니다:

#### 병합의 목적
- "동일 조상 하위의 병합 가능한 메시지를 병합"
- 두 개의 다른 탐색 경로를 하나로 통합

#### 병합의 조건
- 동일 조상(LCA) 하위에서만 가능
- 사용자 승인 필요
- 충돌하는 논리는 보존 영역으로 이동

#### 병합의 프로세스
1. 병합 가능 후보 탐지 (LCA 계산 필요)
2. 사용자에게 제안
3. 사용자 승인
4. 병합 수행 + 체크포인트 생성

**결론**: **병합 기능은 LCA 없이 구현 불가능** ✅

---

## 🏗️ 하이브리드 접근 아키텍처 일관성 검토

### 질문
> "하이브리드 접근 시 아키텍처 일관성 검토"

### 검토 결과: ✅ 일관성 유지 가능

#### 아키텍처 구조 (변경 없음)
```
┌─────────────────────────────────┐
│   Presentation Layer            │
│   - TerminalUI                  │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│   Business Layer                │
│   - PathSwitchService (CLI-1)   │  ← 단순 방식
│   - MergeService (CLI-3)        │  ← LCA 방식 (추가)
│   - CheckpointService           │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│   Algorithm Layer               │
│   [CLI-1]                       │
│   - (LCA 없음)                   │
│                                 │
│   [CLI-3] ← 추가                 │
│   - LCACalculator               │
│   - PathReconstructor           │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│   Data Layer                    │
│   - Node                        │
│   - ConversationTree            │
│   - Store                       │
└─────────────────────────────────┘
```

**변경 영향**:
- Data Layer: 변경 없음 ✅
- Algorithm Layer: CLI-3에서 추가 (기존 코드 영향 없음) ✅
- Business Layer: MergeService 추가 (PathSwitchService 독립) ✅
- Presentation Layer: 명령어 추가만 (구조 변경 없음) ✅

**결론**: 레이어 분리 원칙 유지, 일관성 보장 ✅

---

### 파일 구조 변경

#### Phase CLI-1 구조 (단순화)
```
cli/
├── __init__.py
├── cli.py                 # TerminalUI + main
│
├── core/                  # 핵심 (웹 재사용)
│   ├── __init__.py
│   ├── tree.py            # Node, ConversationTree
│   └── path_utils.py      # get_path_to_root() 단일 함수
│
├── checkpoint.py          # Checkpoint, CheckpointService
├── store.py               # Store
│
└── tests/
    ├── test_tree.py
    ├── test_path.py       # 단순 경로 추적 테스트
    └── test_checkpoint.py
```

**코드량**: ~300줄 (원래 1200줄의 25%)

---

#### Phase CLI-3 구조 (LCA 추가)
```
cli/
├── __init__.py
├── cli.py
│
├── core/
│   ├── __init__.py
│   ├── tree.py
│   ├── path_utils.py      # 기존 (변경 없음)
│   ├── lca.py             # 🆕 LCACalculator
│   └── path_reconstruct.py # 🆕 PathReconstructor (선택)
│
├── checkpoint.py
├── store.py
│
├── merge.py               # 🆕 MergeService
│
└── tests/
    ├── test_tree.py
    ├── test_path.py       # 기존 (변경 없음)
    ├── test_lca.py        # 🆕
    ├── test_merge.py      # 🆕
    └── test_checkpoint.py
```

**추가 코드량**: ~200줄 (병합 전용)

---

### 리팩토링 영향 분석

#### CLI-1 → CLI-3 전환 시 변경사항

**변경 없는 부분**:
- ✅ `core/tree.py` (0줄 변경)
- ✅ `core/path_utils.py` (0줄 변경)
- ✅ `store.py` (0줄 변경)
- ✅ `checkpoint.py` (0줄 변경)
- ✅ `tests/test_tree.py` (0줄 변경)
- ✅ `tests/test_path.py` (0줄 변경)

**추가만 하는 부분**:
- 🆕 `core/lca.py` (새 파일)
- 🆕 `merge.py` (새 파일)
- 🆕 `cli.py` (명령어 [m] 추가, 기존 명령어 유지)

**리팩토링 비용**: **0줄** (추가만, 수정 없음)

---

## ✅ 아키텍처 팀 승인 의견

### 1. plan.md 87-92줄 해석
- **경로 전환 알고리즘**입니다 (병합 아님)
- 하지만 plan.md의 다른 부분(Line 38, 46, 55-59, 542)에 **병합 기능 명확히 명시**
- PM의 지적이 정확합니다

### 2. 하이브리드 접근 승인
**✅ 아키텍처적으로 타당합니다**

**근거**:
1. 레이어 분리 원칙 유지
2. 리팩토링 비용 0 (추가만, 수정 없음)
3. 확장성 보장
4. plan.md 병합 요구사항 충족

### 3. Phase CLI-1 설계서 수정 방향

#### 변경 사항
- ❌ LCA 알고리즘 제거
- ❌ PathReconstructor 제거
- ✅ 단순 경로 추적 (`get_path_to_root`) 유지
- ✅ 4-layer 아키텍처 유지

#### 파일 구조
```
cli/
├── cli.py
├── core/
│   ├── tree.py
│   └── path_utils.py      # get_path_to_root() 단일 함수
├── checkpoint.py
├── store.py
└── tests/
```

#### 클래스 수: 6개 → 5개
- Node ✅
- ConversationTree ✅
- Store ✅
- Checkpoint ✅
- CheckpointService ✅
- ~~PathSwitchService~~ → 단순 함수로 대체

---

## 📊 옵션 비교 (아키텍처 관점)

| 기준 | 옵션 A (LCA 제거) | 옵션 B (LCA 유지) | 옵션 C (하이브리드) ⭐ |
|------|------------------|------------------|---------------------|
| **아키텍처 일관성** | 🔴 중 (CLI-3 리팩토링) | 🟢 높음 | 🟢 높음 |
| **레이어 분리** | 🟢 유지 | 🟢 유지 | 🟢 유지 |
| **리팩토링 비용** | 🔴 높음 (CLI-3) | 🟢 0 | 🟢 0 |
| **확장성** | 🟡 중 | 🟢 높음 | 🟢 높음 |
| **plan.md 충족** | 🔴 병합 미구현 | 🟢 모두 충족 | 🟢 모두 충족 |
| **CLI-1 복잡도** | 🟢 낮음 | 🔴 높음 | 🟢 낮음 |
| **전체 일정** | 🟡 중 (리팩토링) | 🔴 김 (CLI-1) | 🟢 최적 |

**아키텍처 팀 판단**: **옵션 C가 최적**

---

## 🎯 권고사항

### 1. Phase CLI-1 설계서 수정
- [ ] `터미널_프로토타입_설계서.md` 업데이트
  - LCA 알고리즘 제거
  - 단순 경로 추적 강조
  - "Phase CLI-3에서 병합 기능 추가 예정" 명시

- [ ] `기술총괄_인수인계서.md` 업데이트
  - 컴포넌트 5개로 축소
  - 단순 방식 코드 예시 추가
  - CLI-3 확장 계획 명시

### 2. 아키텍처 결정 기록 (ADR)
- [ ] ADR 추가: "Phase CLI-1에서 LCA 제거, CLI-3에서 추가"
  - 컨텍스트: plan.md 병합 기능 존재
  - 결정: 하이브리드 접근
  - 근거: 조기 최적화 방지, 확장성 보장

### 3. Phase CLI-3 설계 가이드라인
- [ ] 병합 기능 상세 설계서 작성 (나중에)
  - LCA 기반 병합 알고리즘
  - 사용자 승인 UX
  - 보존 영역 관리

---

## 📝 설계서 수정 범위

### 즉시 수정 필요
1. `/docs/아키텍처설계/터미널_프로토타입_설계서.md`
   - Section 4.2 (Algorithm Layer) 제거
   - Section 4.3 (Business Layer) 단순화
   - Section 5 (파일 구조) 간소화

2. `/docs/아키텍처설계/기술총괄_인수인계서.md`
   - 컴포넌트 목록 업데이트 (9개 → 5개)
   - 테스트 요구사항 간소화

### 나중에 작성
3. `/docs/아키텍처설계/Phase_CLI-3_설계서.md` (새 파일)
   - 병합 기능 상세 설계
   - LCA 알고리즘 복원

---

## 🔗 참고 문서

### PM 문서
- `docs/PM_관리/PM_보고서/LCA_의사결정_가이드.md` - PM 종합 분석
- `docs/초기개발/PM_보고서/03_LCA_불필요성_제안서.md` - 기술 총괄자 제안

### plan.md 병합 기능 명시 위치
- Line 38: 시나리오 4 (병합 규칙)
- Line 46: 개념 모델 (병합 정의)
- Line 55-59: 병합 규칙 4단계
- Line 542: 병합 UX (사용자 승인)
- Line 410: 컨텍스트 병합 알고리즘

---

## ✅ 최종 의견

### 아키텍처 설계자 승인
**✅ 옵션 C (하이브리드 접근)를 승인합니다.**

**승인 근거**:
1. ✅ plan.md에 병합 기능 명확히 명시됨 (5곳)
2. ✅ 아키텍처 일관성 유지 가능 (레이어 분리)
3. ✅ 리팩토링 비용 0 (추가만, 수정 없음)
4. ✅ CLI-1 단순화 달성 (~300줄)
5. ✅ CLI-3 확장성 보장

### 다음 액션
- [ ] PM 최종 결정 대기
- [ ] 승인 시 Phase CLI-1 설계서 즉시 수정 (2시간)
- [ ] 기술 총괄자에게 단순화 버전 전달

---

**작성 완료**: 2025-11-09
**아키텍처 설계자**: Architecture Team
**검토 대기**: PM, 기술 총괄자

---
